# 用户模块设计文档

## 项目概述
本项目是一个电商平台系统，包含后台管理系统（BackgroundManagementSystem）和用户购物端（yigoushop），采用前后端分离架构。

## 技术栈
- **后端**: Spring Boot 3.2.4 + MyBatis Plus + MySQL + Redis
- **前端**: Vue 3 + Element Plus + Vite
- **数据库**: MySQL 8.0
- **缓存**: Redis
- **邮件服务**: Spring Mail (163邮箱)

## 用户模块整体架构设计

### 1. 模块划分

#### 1.1 用户认证模块 (Authentication)
- **用户注册**: 邮箱验证注册
- **用户登录**: 用户名/邮箱 + 密码登录
- **密码管理**: 密码加密存储、密码重置
- **会话管理**: JWT Token + Redis会话管理

#### 1.2 用户信息管理模块 (User Profile)
- **个人信息**: 基本信息维护
- **头像管理**: 头像上传和更新
- **联系方式**: 手机号、邮箱管理
- **隐私设置**: 个人信息可见性控制

#### 1.3 用户权限管理模块 (Authorization)
- **角色管理**: 普通用户、管理员等角色
- **权限控制**: 基于角色的访问控制(RBAC)
- **菜单权限**: 动态菜单加载
- **操作权限**: 按钮级权限控制

#### 1.4 用户行为模块 (User Behavior)
- **登录记录**: 登录时间、IP地址记录
- **操作日志**: 用户操作行为记录
- **安全监控**: 异常登录检测

## 数据库设计

### 用户表 (sys_user)
```sql
CREATE TABLE `sys_user` (
  `user_id` int(11) NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` varchar(50) NOT NULL COMMENT '用户名',
  `password_hash` varchar(255) NOT NULL COMMENT '加密密码',
  `email` varchar(100) NOT NULL COMMENT '邮箱',
  `phone` varchar(20) DEFAULT NULL COMMENT '手机号',
  `sex` tinyint(1) DEFAULT '1' COMMENT '性别：1-男，2-女',
  `avatar` varchar(255) DEFAULT NULL COMMENT '头像地址',
  `last_login` datetime DEFAULT NULL COMMENT '最后登录时间',
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `level` int(11) DEFAULT '1' COMMENT '用户权限等级：1-普通用户，2-管理员',
  `status` tinyint(1) DEFAULT '1' COMMENT '账户状态：1-正常，0-禁用',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`user_id`),
  UNIQUE KEY `uk_username` (`username`),
  UNIQUE KEY `uk_email` (`email`),
  KEY `idx_level` (`level`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

### 用户登录日志表 (sys_user_login_log)
```sql
CREATE TABLE `sys_user_login_log` (
  `log_id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '日志ID',
  `user_id` int(11) NOT NULL COMMENT '用户ID',
  `login_ip` varchar(45) NOT NULL COMMENT '登录IP',
  `login_time` datetime NOT NULL COMMENT '登录时间',
  `login_type` tinyint(1) DEFAULT '1' COMMENT '登录方式：1-密码登录，2-邮箱验证',
  `user_agent` varchar(500) DEFAULT NULL COMMENT '用户代理',
  `login_result` tinyint(1) DEFAULT '1' COMMENT '登录结果：1-成功，0-失败',
  PRIMARY KEY (`log_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_login_time` (`login_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户登录日志表';
```

## 功能模块详细设计

### 1. 用户注册功能

#### 1.1 注册流程
1. **前端验证**: 用户名、邮箱格式验证
2. **重复性检查**: 用户名、邮箱唯一性验证
3. **邮箱验证**: 发送验证码到邮箱
4. **密码加密**: 使用BCrypt加密存储
5. **用户创建**: 创建用户记录并设置默认权限

#### 1.2 已实现功能
- ✅ 邮箱格式验证
- ✅ 用户名重复检查
- ✅ 邮箱重复检查
- ✅ 邮箱验证码发送
- ✅ 密码加密存储
- ✅ 用户注册接口

#### 1.3 需要完善的功能
- ⚠️ 手机号验证（可选）
- ⚠️ 注册协议确认
- ⚠️ 注册成功后的自动登录

### 2. 用户登录功能

#### 2.1 登录流程设计
1. **身份验证**: 用户名/邮箱 + 密码验证
2. **密码验证**: BCrypt密码比对
3. **JWT生成**: 生成访问令牌
4. **会话管理**: Redis存储用户会话
5. **登录记录**: 记录登录日志
6. **权限加载**: 加载用户权限和菜单

#### 2.2 当前状态
- ⚠️ 登录接口未完全实现
- ⚠️ JWT Token机制待实现
- ⚠️ 会话管理待完善

#### 2.3 需要实现的功能
- 🔲 用户登录接口
- 🔲 JWT Token生成和验证
- 🔲 Redis会话管理
- 🔲 登录日志记录
- 🔲 记住登录状态
- 🔲 自动登录功能

### 3. 用户信息管理

#### 3.1 个人信息管理
- **基本信息**: 用户名、邮箱、手机号、性别
- **头像管理**: 头像上传、预览、删除
- **密码修改**: 旧密码验证 + 新密码设置
- **邮箱绑定**: 邮箱更换验证

#### 3.2 当前实现状态
- ✅ 用户信息查看（后台管理）
- ✅ 用户信息编辑（后台管理）
- ✅ 用户删除（后台管理）
- ✅ 头像显示
- ⚠️ 头像上传功能待完善
- ⚠️ 用户端个人信息管理待实现

### 4. 权限管理系统

#### 4.1 权限设计
```
权限等级设计：
- Level 1: 普通用户 - 只能访问购物端功能
- Level 2: 管理员 - 可以访问后台管理系统
- Level 3: 超级管理员 - 系统完全控制权限
```

#### 4.2 权限控制点
- **路由权限**: 根据用户等级控制页面访问
- **接口权限**: 后端接口访问控制
- **菜单权限**: 动态菜单显示
- **操作权限**: 按钮级权限控制

#### 4.3 当前实现状态
- ✅ 用户等级字段存在
- ⚠️ 权限验证机制待实现
- ⚠️ 动态菜单加载待完善

## 接口设计规范

### 1. 统一响应格式
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {},
  "timestamp": 1640995200000
}
```

### 2. 用户相关接口

#### 2.1 用户注册接口
```
POST /user/register
Content-Type: multipart/form-data

参数:
- username: 用户名
- email: 邮箱
- passwordHash: 密码
- phone: 手机号（可选）
- sex: 性别
- code: 邮箱验证码

响应:
{
  "code": 200,
  "message": "注册成功",
  "data": null
}
```

#### 2.2 用户登录接口
```
POST /user/login
Content-Type: application/json

参数:
{
  "account": "用户名或邮箱",
  "password": "密码",
  "rememberMe": true
}

响应:
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "JWT_TOKEN",
    "userInfo": {
      "userId": 1,
      "username": "testuser",
      "email": "test@example.com",
      "level": 1,
      "avatar": "avatar_url"
    }
  }
}
```

#### 2.3 用户信息获取
```
GET /user/profile
Headers: Authorization: Bearer JWT_TOKEN

响应:
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "userId": 1,
    "username": "testuser",
    "email": "test@example.com",
    "phone": "13800138000",
    "sex": 1,
    "avatar": "avatar_url",
    "level": 1,
    "lastLogin": "2024-01-01 12:00:00"
  }
}
```

## 安全设计

### 1. 密码安全
- **加密存储**: 使用BCrypt算法加密密码
- **密码强度**: 前端验证密码复杂度
- **密码重置**: 邮箱验证重置密码

### 2. 会话安全
- **JWT Token**: 无状态身份验证
- **Token过期**: 设置合理的过期时间
- **刷新Token**: 支持Token刷新机制
- **Redis存储**: 敏感信息存储在Redis中

### 3. 接口安全
- **参数验证**: 严格验证输入参数
- **SQL注入防护**: 使用MyBatis Plus防止SQL注入
- **XSS防护**: 前端输入过滤
- **CSRF防护**: 跨站请求伪造防护

## 前端设计

### 1. 用户端功能
- **注册页面**: 用户注册表单
- **登录页面**: 用户登录表单
- **个人中心**: 个人信息管理
- **密码修改**: 密码修改页面

### 2. 管理端功能
- **用户列表**: 用户信息展示和管理
- **用户编辑**: 用户信息编辑
- **权限管理**: 用户权限设置
- **登录日志**: 用户登录记录查看

## 开发计划

### 第一阶段：基础功能完善（优先级：高）
1. **完成登录接口实现**
   - 实现用户登录验证
   - 集成JWT Token机制
   - 完善Redis会话管理

2. **完善权限验证**
   - 实现基于角色的权限控制
   - 完善前端路由守卫
   - 实现动态菜单加载

3. **完善用户管理功能**
   - 实现头像上传功能
   - 完善用户信息编辑
   - 实现密码修改功能

### 第二阶段：功能增强（优先级：中）
1. **安全功能增强**
   - 实现登录日志记录
   - 添加异常登录检测
   - 完善密码重置功能

2. **用户体验优化**
   - 实现记住登录状态
   - 添加自动登录功能
   - 优化界面交互

### 第三阶段：高级功能（优先级：低）
1. **高级权限管理**
   - 实现细粒度权限控制
   - 添加权限继承机制
   - 实现权限审计功能

2. **用户行为分析**
   - 用户行为统计
   - 登录趋势分析
   - 用户活跃度监控

## 技术实现要点

### 1. 后端实现要点
- **使用Spring Security**: 集成Spring Security进行安全控制
- **JWT工具类**: 封装JWT生成和验证工具
- **Redis配置**: 配置Redis作为缓存和会话存储
- **异常处理**: 统一异常处理机制
- **日志记录**: 使用AOP记录用户操作日志

### 2. 前端实现要点
- **状态管理**: 使用Pinia管理用户状态
- **路由守卫**: 实现基于权限的路由守卫
- **API封装**: 统一API调用和错误处理
- **组件复用**: 封装用户相关组件
- **表单验证**: 实现前端表单验证

## 测试策略

### 1. 单元测试
- 用户服务层测试
- 权限验证测试
- 密码加密测试

### 2. 集成测试
- 用户注册流程测试
- 用户登录流程测试
- 权限控制测试

### 3. 接口测试
- 使用Postman测试所有接口
- 验证接口响应格式
- 测试异常情况处理

## 部署和运维

### 1. 环境配置
- **开发环境**: 本地开发配置
- **测试环境**: 测试环境配置
- **生产环境**: 生产环境配置

### 2. 监控和日志
- **应用监控**: 监控用户登录情况
- **错误日志**: 记录用户操作错误
- **性能监控**: 监控接口响应时间

## 总结

用户模块是整个电商平台的核心基础模块，需要确保安全性、稳定性和易用性。当前项目已经有了良好的基础架构，主要需要完善登录功能、权限管理和一些用户体验功能。

建议按照开发计划的优先级逐步实现，先确保核心功能稳定运行，再逐步添加高级功能。
