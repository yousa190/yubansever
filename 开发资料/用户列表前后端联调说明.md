# 用户列表前后端联调说明

## 概述

已完成用户列表功能的前后端联调，取消了mock模拟数据，实现了真实的后端接口调用。

## 后端实现

### 1. 接口定义

**接口路径**: `GET /user/list`

**请求参数**:
```javascript
{
  keyWord: string,     // 搜索关键词（可选）
  searchType: string,  // 搜索类型：username, email, phone（可选，默认username）
  page: number,        // 页码，从1开始（可选，默认1）
  pageSize: number     // 每页数量（可选，默认10）
}
```

**响应格式**:
```javascript
{
  code: 200,
  message: "操作成功",
  data: {
    list: [
      {
        userId: 1,
        username: "testuser",
        email: "test@example.com",
        phone: "13800138000",
        sex: 1,
        avatar: "http://localhost:8080/images/users/defaultAvatar.jpg",
        lastLogin: "2024-01-01 12:00:00",
        createdAt: "2024-01-01 10:00:00",
        updatedAt: "2024-01-01 10:00:00",
        level: 1,
        isDel: 0
      }
    ],
    count: 100,        // 总记录数
    totalPage: 10,     // 总页数
    currentPage: 1,    // 当前页
    pageSize: 10       // 每页数量
  }
}
```

### 2. 后端代码实现

#### Controller层 (`UserController.java`)
```java
@Operation(summary = "获取用户列表", description = "分页获取用户列表，支持按用户名、邮箱、手机号搜索")
@GetMapping("/list")
public Result getUserList(
        @Parameter(description = "搜索关键词") @RequestParam(required = false, defaultValue = "") String keyWord,
        @Parameter(description = "搜索类型") @RequestParam(required = false, defaultValue = "username") String searchType,
        @Parameter(description = "页码，从1开始") @RequestParam(defaultValue = "1") Integer page,
        @Parameter(description = "每页数量") @RequestParam(defaultValue = "10") Integer pageSize) {
    
    return userService.getUserList(keyWord, searchType, page, pageSize);
}
```

#### Service层 (`UserService.java`)
```java
/**
 * 获取用户列表（分页）
 * @param keyWord 搜索关键词
 * @param searchType 搜索类型：username, email, phone
 * @param page 页码
 * @param pageSize 每页数量
 * @return 分页用户列表
 */
public Result getUserList(String keyWord, String searchType, Integer page, Integer pageSize);
```

#### Service实现层 (`UserServiceimpl.java`)
```java
@Override
public Result getUserList(String keyWord, String searchType, Integer page, Integer pageSize) {
    try {
        // 创建分页对象
        Page<UserData> pageData = new Page<>(page, pageSize);
        
        // 创建查询条件
        LambdaQueryWrapper<UserData> queryWrapper = new LambdaQueryWrapper<>();
        
        // 根据搜索类型和关键词添加查询条件
        if (StringUtils.hasText(keyWord)) {
            switch (searchType) {
                case "username":
                    queryWrapper.like(UserData::getUsername, keyWord);
                    break;
                case "email":
                    queryWrapper.like(UserData::getEmail, keyWord);
                    break;
                case "phone":
                    queryWrapper.like(UserData::getPhone, keyWord);
                    break;
                default:
                    queryWrapper.like(UserData::getUsername, keyWord);
                    break;
            }
        }
        
        // 按创建时间倒序排列
        queryWrapper.orderByDesc(UserData::getCreatedAt);
        
        // 执行分页查询
        Page<UserData> result = usermapper.selectPage(pageData, queryWrapper);
        
        // 构建返回数据
        Map<String, Object> data = new HashMap<>();
        data.put("list", result.getRecords());
        data.put("count", result.getTotal());
        data.put("totalPage", result.getPages());
        data.put("currentPage", page);
        data.put("pageSize", pageSize);
        
        return Result.success(data);
        
    } catch (Exception e) {
        return Result.error("获取用户列表失败：" + e.getMessage());
    }
}
```

## 前端实现

### 1. API配置更新

**文件**: `BackgroundManagementSystem/src/api/api.js`

**更新内容**:
```javascript
getUserInfoData(data){
    return request({
        url:'/user/list',      // 修改为真实接口路径
        method:"get",
        mock: false,           // 取消mock数据
        params: data,          // 使用params传递查询参数
    })
}
```

### 2. 前端调用逻辑

**文件**: `BackgroundManagementSystem/src/views/User.vue`

**获取用户列表函数**:
```javascript
const getUserTableD = async () => {
  try {
    // 构建请求参数
    const params = {
      keyWord: config.username,
      searchType: config.searchType,
      page: config.page,
      pageSize: config.pageSize
    }
    
    let res = await proxy.$api.getUserInfoData(params)
    
    if (res.code === 200) {
      tableData.value = res.data.list.map(item=>{
        return {
          ...item,
          sex: item.sex === 1 ? "男" : "女",
          level: getLevelText(item.level),
          status: item.isDel === 0 ? "正常" : "已删除",
          lastLogin: item.lastLogin ? formatDate(item.lastLogin) : "从未登录",
          createdAt: formatDate(item.createdAt)
        }
      })
      config.total = res.data.count
    } else {
      ElMessage.error(res.message || '获取用户列表失败')
    }
  } catch (error) {
    console.error('获取用户列表失败:', error)
    ElMessage.error('获取用户列表失败，请检查网络连接')
  }
}
```

## 功能特性

### 1. 分页功能
- ✅ 支持分页查询
- ✅ 可配置每页数量（10/20/50/100）
- ✅ 支持页码跳转
- ✅ 显示总记录数

### 2. 搜索功能
- ✅ 支持按用户名搜索
- ✅ 支持按邮箱搜索
- ✅ 支持按手机号搜索
- ✅ 模糊搜索（LIKE查询）
- ✅ 搜索类型动态切换

### 3. 排序功能
- ✅ 按创建时间倒序排列
- ✅ 最新用户显示在前

### 4. 数据格式化
- ✅ 性别字段格式化（1→男，2→女）
- ✅ 权限等级格式化（1→普通用户，2→管理员，3→超级管理员）
- ✅ 状态格式化（0→正常，1→已删除）
- ✅ 时间字段格式化（中文日期时间格式）

### 5. 错误处理
- ✅ 网络错误处理
- ✅ 接口错误处理
- ✅ 用户友好的错误提示

## 数据库查询逻辑

### 1. 基础查询
```sql
SELECT * FROM sys_user 
ORDER BY created_at DESC 
LIMIT ?, ?
```

### 2. 搜索查询
```sql
-- 按用户名搜索
SELECT * FROM sys_user 
WHERE username LIKE '%关键词%' 
ORDER BY created_at DESC 
LIMIT ?, ?

-- 按邮箱搜索
SELECT * FROM sys_user 
WHERE email LIKE '%关键词%' 
ORDER BY created_at DESC 
LIMIT ?, ?

-- 按手机号搜索
SELECT * FROM sys_user 
WHERE phone LIKE '%关键词%' 
ORDER BY created_at DESC 
LIMIT ?, ?
```

## 测试建议

### 1. 功能测试
- [ ] 页面加载时显示用户列表
- [ ] 分页功能正常
- [ ] 搜索功能正常（用户名、邮箱、手机号）
- [ ] 数据格式化显示正确
- [ ] 错误处理正常

### 2. 性能测试
- [ ] 大数据量分页性能
- [ ] 搜索响应时间
- [ ] 页面加载速度

### 3. 边界测试
- [ ] 空搜索结果
- [ ] 网络异常情况
- [ ] 无效搜索参数

## 部署注意事项

### 1. 数据库准备
确保数据库中有测试数据，可以通过以下SQL插入测试数据：
```sql
INSERT INTO sys_user (username, password_hash, email, phone, sex, avatar, level, is_del, created_at, updated_at) 
VALUES 
('testuser1', 'hashed_password', 'test1@example.com', '13800138001', 1, 'http://localhost:8080/images/users/defaultAvatar.jpg', 1, 0, NOW(), NOW()),
('testuser2', 'hashed_password', 'test2@example.com', '13800138002', 2, 'http://localhost:8080/images/users/defaultAvatar.jpg', 2, 0, NOW(), NOW());
```

### 2. 接口测试
可以通过以下URL测试接口：
```
GET http://localhost:8080/user/list
GET http://localhost:8080/user/list?page=1&pageSize=10
GET http://localhost:8080/user/list?keyWord=test&searchType=username
```

## 总结

用户列表功能的前后端联调已完成，主要特点：

- ✅ **真实数据**: 取消mock，使用真实数据库数据
- ✅ **完整功能**: 分页、搜索、排序功能完整
- ✅ **错误处理**: 完善的错误处理机制
- ✅ **数据格式化**: 友好的数据显示格式
- ✅ **性能优化**: 使用MyBatis Plus分页插件
- ✅ **接口规范**: 统一的接口响应格式

现在可以正常使用用户管理功能进行用户列表的查看和管理！
